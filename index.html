<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentación de Procesos SAP S/4HANA - Grupo Portland</title>
    <!-- Importar fuentes e iconos -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librería para exportar a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            --sap-blue: #008FD3;
            --sap-dark-blue: #003366;
            --portland-blue: #0b2b5c; 
            --accent-green: #6bae47; 
            --light-gray: #f4f4f4;
            --disabled-gray: #b0b0b0;
            --text-color: #333;
            --card-shadow: 0 4px 6px rgba(0,0,0,0.05);
            --card-hover: 0 10px 20px rgba(0,0,0,0.12);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
            color: var(--text-color);
            line-height: 1.5;
        }

        /* --- Header & Navigation --- */
        header {
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-img {
            height: 45px;
            object-fit: contain;
        }

        .sap-logo {
            height: 35px;
        }

        /* --- Hero Section --- */
        .hero {
            position: relative;
            height: 350px;
            /* Se usa un degradado sobre la imagen para mejorar legibilidad del texto */
            background-image: linear-gradient(rgba(11, 43, 92, 0.85), rgba(11, 43, 92, 0.65)), url('Imagenes/Hero_banner_small.png'); 
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            padding: 20px;
        }

        .hero-content {
            max-width: 900px;
            animation: fadeIn 1.2s ease;
        }

        .hero h1 {
            font-size: 2.2rem;
            margin-bottom: 15px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .hero p {
            font-size: 1.1rem;
            font-weight: 300;
        }

        .project-logo-hero {
            height: 200px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.95);
            padding: 10px;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }

        /* --- Main Content --- */
        .container {
            max-width: 1400px; /* Ancho amplio para que quepan las 5 tarjetas */
            margin: 40px auto;
            padding: 0 30px;
        }

        .phase-section {
            margin-bottom: 60px;
        }

        .phase-title {
            color: var(--portland-blue);
            font-size: 1.6rem;
            margin-bottom: 25px;
            padding-bottom: 8px;
            border-bottom: 3px solid var(--accent-green);
            display: inline-block;
        }

        /* --- GRID SYSTEM (La clave para 5 por línea) --- */
        .process-grid {
            display: grid;
            /* Exactamente 5 columnas de igual tamaño */
            grid-template-columns: repeat(5, 1fr); 
            gap: 30px; /* Espacio entre tarjetas */
            align-items: stretch; /* Estira las tarjetas para que tengan la misma altura */
        }

        /* --- Step Card --- */
        .step-card {
            background: white;
            border-radius: 10px;
            padding: 25px 15px;
            text-align: center;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            border-top: 5px solid var(--sap-blue);
            
            /* Flexbox interno para distribuir contenido verticalmente */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%; 
        }

        .step-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-hover);
        }

        /* Flechas Automáticas entre tarjetas */
        .step-card::after {
            content: "\f061"; /* Código unicode flecha FontAwesome */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            right: -22px; /* Posición en el hueco entre tarjetas */
            top: 45%;
            color: #ccc;
            font-size: 1.2rem;
            z-index: 1;
        }

        /* Eliminar flecha del último elemento de la fila */
        .step-card:last-child::after {
            display: none;
        }
        
        /* En la fase 2, el 4to elemento es el último, quitar su flecha también si no hay 5to */
        .process-grid:has(.step-card:nth-last-child(1):nth-child(4)) .step-card:nth-child(4)::after {
             display: none; /* Soporte navegadores modernos */
        }

        /* --- Card Content --- */
        .icon-box {
            font-size: 2.2rem;
            color: var(--portland-blue);
            margin-bottom: 15px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .step-title {
            font-weight: 700;
            font-size: 1.05rem;
            margin-bottom: 15px;
            color: #333;
            min-height: 3rem; /* Altura mínima para títulos de 2 líneas */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .step-action {
            margin-top: auto; /* Empuja el botón al fondo */
            width: 100%;
        }

        /* --- Buttons --- */
        .btn-manual {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: var(--sap-dark-blue);
            color: white;
            padding: 12px 8px;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            width: 100%;
            border: none;
            cursor: pointer;
            min-height: 65px;
        }

        .btn-manual:hover {
            background-color: var(--sap-blue);
        }

        .btn-text {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .btn-code {
            font-size: 1rem;
            font-family: SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;
            font-weight: 700;
            letter-spacing: 0.5px;
            background: rgba(0, 0, 0, 0.25);
            padding: 3px 8px;
            border-radius: 4px;
        }

        /* Estilo Deshabilitado */
        .btn-disabled {
            background-color: #e0e0e0 !important;
            color: #888 !important;
            cursor: not-allowed;
            pointer-events: none;
            box-shadow: none;
        }
        
        .btn-disabled .btn-code {
            background: rgba(0,0,0,0.05);
        }

        /* --- Footer --- */
        footer {
            background-color: var(--portland-blue);
            color: white;
            text-align: center;
            padding: 30px;
            margin-top: 50px;
        }

        footer p {
            font-size: 0.9rem;
            opacity: 0.8;
        }
/* Estenedor del Chat Flotante */
    #floatingChat {
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        transform: translateY(30px) scale(0.95);
        opacity: 0;
        pointer-events: none;
        position: fixed; bottom: 100px; right: 24px; z-index: 50;
    }
    #floatingChat.active {
        transform: translateY(0) scale(1);
        opacity: 1;
        pointer-events: auto;
    }
    .chat-window { height: 650px; width: 480px; max-width: 95vw; }
    
    /* Estilos de las burbujas y contenido renderizado */
    .chat-bubble-content h3 { font-size: 1.1rem; font-weight: 700; color: #0f172a; border-left: 4px solid #3b82f6; padding-left: 8px; margin: 1rem 0 0.5rem; }
    .chat-bubble-content code { background: #f1f5f9; padding: 2px 5px; border-radius: 4px; font-family: monospace; color: #2563eb; }
    
    /* Animación de escritura */
    .typing-dot { width: 6px; height: 6px; background: #3b82f6; border-radius: 50%; display: inline-block; animation: typing 1.4s infinite ease-in-out; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing { 0%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-5px); } }

    /* Animación del botón circular */
    .pulse-animation { animation: pulse 2s infinite; }
    @keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); }
        70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
    }
#chatLabel {
    pointer-events: none; /* Evita que interfiera con clics */
    box-shadow: -4px 4px 10px rgba(0,0,0,0.2);
    border: 1px solid rgba(255,255,255,0.1);
}

/* Estado cuando el chat está abierto (ocultar etiqueta) */
#chatLabel.hidden-label {
    opacity: 0;
    transform: translateX(20px);
    pointer-events: none;
}
    
    /* Estilos para tablas dentro del chat */
.chat-bubble-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
    font-size: 0.85rem;
    background: white;
}

.chat-bubble-content th {
    background-color: #f1f5f9;
    color: #003366;
    font-weight: 700;
    padding: 8px;
    border: 1px solid #e2e8f0;
}

.chat-bubble-content td {
    padding: 8px;
    border: 1px solid #e2e8f0;
}

.chat-bubble-content tr:nth-child(even) {
    background-color: #f8fafc;
}

/* Espacio superior para el icono de PDF y manejo de tablas */
.chat-bubble-content {
    overflow-x: auto;
    padding-top: 32px !important; 
    position: relative;
}

/* Estilo del botón PDF dentro de la burbuja */
.pdf-export-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    color: #ef4444; /* Rojo */
    opacity: 0.6;
    transition: all 0.2s;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.1rem;
    z-index: 20;
}

.pdf-export-btn:hover {
    opacity: 1;
    transform: scale(1.1);
}
/* Estilo forzado para el botón de soporte */
.support-btn {
    display: inline-flex !important;
    align-items: center;
    justify-content: center;
    background-color: #003366 !important; /* Azul Portland */
    color: white !important;
    padding: 10px 20px !important;
    border-radius: 9999px !important;
    font-size: 12px !important;
    font-weight: 600 !important;
    text-decoration: none !important;
    margin-top: 12px !important;
    border: none !important;
    cursor: pointer !important;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
    transition: all 0.2s ease !important;
}

.support-btn:hover {
    background-color: #004080 !important;
    transform: translateY(-1px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;
}

.support-container {
    margin-top: 15px;
    padding: 15px;
    background-color: #f0f7ff;
    border: 1px dashed #003366;
    border-radius: 12px;
    text-align: center;
}
/* Estilo para listas numeradas (Pasos del Proceso) */
.chat-bubble-content ol {
    counter-reset: step-counter;
    list-style-type: none;
    padding-left: 0;
    margin-top: 15px;
}

.chat-bubble-content ol li {
    position: relative;
    margin-bottom: 12px;
    padding: 10px 15px 10px 45px;
    background: #f8fafc;
    border-left: 4px solid #003366;
    border-radius: 4px 8px 8px 4px;
    font-size: 0.9rem;
    line-height: 1.4;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.02);
}

/* Burbuja del número del paso */
.chat-bubble-content ol li::before {
    content: counter(step-counter);
    counter-increment: step-counter;
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    background-color: #003366;
    color: white;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: bold;
}

/* Estilo para listas con viñetas (Puntos clave) */
.chat-bubble-content ul {
    list-style-type: none;
    padding-left: 0;
}

.chat-bubble-content ul li::before {
    content: "•";
    color: #6bae47; /* Verde Portland */
    font-weight: bold;
    display: inline-block; 
    width: 1em;
    margin-left: 5px;
}
        /* --- Responsive Design --- */
        /* Ajuste para pantallas medianas (Tablets) */
        @media (max-width: 1200px) {
            .process-grid {
                grid-template-columns: repeat(3, 1fr); /* Bajar a 3 columnas */
                gap: 20px;
            }
            .step-card::after {
                display: none; /* Ocultar flechas en layout no lineal */
            }
        }

        /* Ajuste para móviles */
        @media (max-width: 768px) {
            .process-grid {
                grid-template-columns: 1fr; /* 1 columna */
            }
            .hero {
                height: 300px;
            }
            header {
                flex-direction: column;
                gap: 10px;
            }
            .logo-container {
                margin-bottom: 5px;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="logo-container">
            <img src="Imagenes/Logo_Portland.png" alt="Grupo Portland" class="logo-img">
        </div>
        <img src="Imagenes/Logo_SAP.jpeg" alt="SAP" class="logo-img sap-logo">
    </header>

    <!-- Hero Section -->
    <section class="hero">
        <img src="Imagenes/Logo_Proyecto.png" alt="Proyecto SAP S4" class="project-logo-hero">
        <div class="hero-content">
            <h1>Manuales de Usuario SAP S/4HANA</h1>
            <p>Acceso centralizado a la documentación operativa estándar para el Grupo Portland.</p>
        </div>
    </section>

    <!-- Main Content -->
    <div class="container">

        <!-- FASE 1: Aprovisionamiento -->
        <div class="phase-section">
            <h2 class="phase-title">Proceso de Aprovisionamiento</h2>
            
            <!-- Grid de 5 Columnas -->
            <div class="process-grid">
                
                <!-- Paso 1 -->
                <div class="step-card">
                    <div class="icon-box"><i class="fa-solid fa-ship"></i></div>
                    <div class="step-title">Compra y Costeo <br> (Comercial) </div>
                    <div class="step-action">
                        <a href="#" class="btn-manual" data-manual="ME21N">
                            <span class="btn-text">Ver Manual</span>
                            <span class="btn-code">ME21N</span>
                        </a>
                    </div>
                </div>

                <!-- Paso 2 -->
                <div class="step-card">
                    <div class="icon-box"><i class="fa-solid fa-file-signature"></i></div>
                    <div class="step-title">Aprobación <br> (Gerencia) </div>
                    <div class="step-action">
                        <a href="#" class="btn-manual" data-manual="ME29N">
                            <span class="btn-text">Ver Manual</span>
                            <span class="btn-code">ME29N</span>
                        </a>
                    </div>
                </div>

                <!-- Paso 3 -->
                <div class="step-card">
                    <div class="icon-box"><i class="fa-solid fa-warehouse"></i></div>
                    <div class="step-title">Recepción de Mercancía <br> (Logística) </div>
                    <div class="step-action">
                        <a href="#" class="btn-manual" data-manual="MIGO">
                            <span class="btn-text">Ver Manual</span>
                            <span class="btn-code">MIGO</span>
                        </a>
                    </div>
                </div>

                <!-- Paso 4 -->
                <div class="step-card">
                    <div class="icon-box"><i class="fa-solid fa-magnifying-glass-dollar"></i></div>
                    <div class="step-title">Verificación/Contabilización de Factura <br> (Contabilidad) </div>
                    <div class="step-action">
                        <a href="#" class="btn-manual" data-manual="MIRO">
                            <span class="btn-text">Ver Manual</span>
                            <span class="btn-code">MIRO</span>
                        </a>
                    </div>
                </div>

                <!-- Paso 5 -->
                <div class="step-card">
                    <div class="icon-box"><i class="fa-solid fa-money-bill-transfer"></i></div>
                    <div class="step-title">Pago a Proveedores <br> (Tesorería) </div>
                    <div class="step-action">
                        <a href="#" class="btn-manual" data-manual="F110">
                            <span class="btn-text">Ver Manual</span>
                            <span class="btn-code">F110</span>
                        </a>
                    </div>
                </div>

            </div>
        </div>

        <!-- FASE 2: Ventas -->
        <div class="phase-section">
            <h2 class="phase-title">Proceso de Venta y Distribución </h2>
            
            <div class="process-grid">
                
                <!-- Paso 1 -->
                <div class="step-card" style="border-top-color: var(--accent-green);">
                    <div class="icon-box"><i class="fa-solid fa-file-contract"></i></div>
                    <div class="step-title">Pedido de Venta <br> (Comercial) </div>
                    <div class="step-action">
                        <a href="#" class="btn-manual" data-manual="VA01">
                            <span class="btn-text">Ver Manual</span>
                            <span class="btn-code">VA01</span>
                        </a>
                    </div>
                </div>

                <!-- Paso 2 -->
                <div class="step-card" style="border-top-color: var(--accent-green);">
                    <div class="icon-box"><i class="fa-solid fa-truck-fast"></i></div>
                    <div class="step-title">Despacho y Entrega <br> (Logística) </div>
                    <div class="step-action">
                        <a href="#" class="btn-manual" data-manual="VL01N">
                            <span class="btn-text">Ver Manual</span>
                            <span class="btn-code">VL01N</span>
                        </a>
                    </div>
                </div>

                <!-- Paso 3 -->
                <div class="step-card" style="border-top-color: var(--accent-green);">
                    <div class="icon-box"><i class="fa-solid fa-file-invoice"></i></div>
                    <div class="step-title">Facturación <br> (Credito) </div>
                    <div class="step-action">
                        <a href="#" class="btn-manual" data-manual="VF01">
                            <span class="btn-text">Ver Manual</span>
                            <span class="btn-code">VF01</span>
                        </a>
                    </div>
                </div>

                <!-- Paso 4 -->
                <div class="step-card" style="border-top-color: var(--accent-green);">
                    <div class="icon-box"><i class="fa-solid fa-building-columns"></i></div>
                    <div class="step-title">Cobro <br> (Cobranzas)</div>
                    <div class="step-action">
                        <a href="#" class="btn-manual" data-manual="F-28">
                            <span class="btn-text">Ver Manual</span>
                            <span class="btn-code">F-28</span>
                        </a>
                    </div>
                </div>
                
                <!-- El espacio 5 queda vacío automáticamente para mantener la estructura de grilla -->

            </div>
        </div>


        <!-- FASE 3: Datos Maestros -->
        <div class="phase-section">
            <h2 class="phase-title">Otros Procesos Clave</h2>
            
            <div class="process-grid">
            
                <!-- Paso 3.1 -->
                <div class="step-card">
                    <div class="icon-box"><i class="fa-solid fa-industry"></i></div>
                    <div class="step-title">Maquila <br> (Logística) </div>
                    <div class="step-action">
                        <a href="#" class="btn-manual" data-manual="MAQ">
                            <span class="btn-text">Ver Manual</span>
                            <span class="btn-code">ME21N</span>
                        </a>
                    </div>
                </div>
                <!-- Paso 3.2 -->
                <div class="step-card">
                    <div class="icon-box"><i class="fa-solid fa-warehouse"></i></div>
                    <div class="step-title">Inventario <br> (Logística/Contabilidad) </div>
                    <div class="step-action">
                        <a href="#" class="btn-manual" data-manual="INV">
                            <span class="btn-text">Ver Manual</span>
                            <span class="btn-code">MI04</span>
                        </a>
                    </div>
                </div>
                <!-- Paso 3.3 -->
                <div class="step-card">
                    <div class="icon-box"><i class="fa-solid fa-file-invoice"></i></div>
                    <div class="step-title">Registro de Facturas Manuales<br> (Contabilidad/Tesorería) </div>
                    <div class="step-action">
                        <a href="#" class="btn-manual" data-manual="FB60">
                            <span class="btn-text">Ver Manual</span>
                            <span class="btn-code">FB60</span>
                        </a>
                    </div>
                </div>       
                    <div class="step-card">
                    <div class="icon-box"><i class="fa-solid fa-money-bill-transfer"></i></div>
                    <div class="step-title">Pago Manual a Proveedores <br> (Tesorería) </div>
                    <div class="step-action">
                        <a href="#" class="btn-manual" data-manual="F-51">
                            <span class="btn-text">Ver Manual</span>
                            <span class="btn-code">F-51</span>
                        </a>
                    </div>
                </div>             
                <!-- Paso 3.2 -->
                <div class="step-card" style="border-top-color: var(--accent-green);">
                    <div class="icon-box"><i class="fa-solid fa-user-tie"></i></div>
                    <div class="step-title">Creación Socio de Negocio Tipo Proveedor <br> (TI) </div>
                    <div class="step-action">
                        <a href="#" class="btn-manual" data-manual="BP1">
                            <span class="btn-text">Ver Manual</span>
                            <span class="btn-code">BP</span>
                        </a>
                    </div>
                </div>
                <!-- Paso 3.3 -->
                <div class="step-card" style="border-top-color: var(--accent-green);">
                    <div class="icon-box"><i class="fa-solid fa-users"></i></div>
                    <div class="step-title">Creación Socio de Negocio Tipo Cliente <br> (TI) </div>
                    <div class="step-action">
                        <a href="#" class="btn-manual" data-manual="BP2">
                            <span class="btn-text">Ver Manual</span>
                            <span class="btn-code">BP</span>
                        </a>
                    </div>
                </div>
                <!-- Paso 3.3 -->
                <div class="step-card" style="border-top-color: var(--accent-green);">
                    <div class="icon-box"><i class="fa-solid fa-credit-card"></i></div>
                    <div class="step-title">Gestión de Crédito <br> (Credito) </div>
                    <div class="step-action">
                        <a href="#" class="btn-manual" data-manual="BP3">
                            <span class="btn-text">Ver Manual</span>
                            <span class="btn-code">BP</span>
                        </a>
                    </div>
                </div>
                <!-- Paso 3.3 -->
                <div class="step-card" style="border-top-color: var(--accent-green);">
                    <div class="icon-box"><i class="fa-solid fa-cubes"></i></div>
                    <div class="step-title">Gestión de Materiales <br> (TI) </div>
                    <div class="step-action">
                        <a href="#" class="btn-manual" data-manual="MM01">
                            <span class="btn-text">Ver Manual</span>
                            <span class="btn-code">MM01</span>
                        </a>
                    </div>
                </div>                
                
                <!-- El espacio 5 queda vacío automáticamente para mantener la estructura de grilla -->

            </div>
        </div>

    <div id="floatingChat">
    <div class="chat-window bg-white rounded-[2.5rem] shadow-2xl border border-slate-200 flex flex-col overflow-hidden">
        <div class="bg-[#003366] p-5 text-white flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-11 h-11 bg-blue-500 rounded-full flex items-center justify-center"><i class="fas fa-robot"></i></div>
                <div><h4 class="font-bold text-sm">Asistente IA de Portland</h4></div>
            </div>
            <div class="flex space-x-1">
                <button onclick="clearChat()" class="p-2 hover:bg-white/10 rounded-xl"><i class="fas fa-eraser text-xs"></i></button>
                <button onclick="toggleChat()" class="p-2 hover:bg-white/10 rounded-xl"><i class="fas fa-times"></i></button>
            </div>
        </div>

        <div id="chatBox" class="flex-grow overflow-y-auto p-6 space-y-6 bg-slate-50/50" style="height: 400px;"></div>

        <div id="typingIndicator" class="hidden px-6 py-2">
            <div class="flex space-x-2 bg-white border p-2.5 w-20 justify-center rounded-full"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>
        </div>

        <div class="p-4 bg-white border-t">
            <form id="chatForm" class="flex items-center space-x-3">
                <input type="text" id="userInput" placeholder="Escribe tu consulta..." class="flex-grow p-4 bg-slate-100 rounded-[1.5rem] focus:outline-none text-sm">
                <button type="submit" class="bg-[#003366] text-white w-12 h-12 rounded-2xl hover:bg-blue-800 transition-all"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>
    </div>
</div>

<div id="chatButtonContainer" class="fixed bottom-6 right-6 flex items-center z-50">
    <span id="chatLabel" class="bg-[#003366] text-white px-4 py-2 rounded-l-full mr-[-20px] pr-8 shadow-lg text-sm font-medium transition-all duration-300 transform translate-x-0 opacity-100">
        Pregúntale al Asistente
    </span>
    <button id="chatToggleBtn" onclick="toggleChat()" class="w-16 h-16 bg-[#003366] text-white rounded-full shadow-2xl flex items-center justify-center pulse-animation relative z-10">
        <i class="fas fa-comment-dots text-2xl" id="toggleIcon"></i>
    </button>
</div>

    </div>
    <!-- Footer -->
    <footer>
        <p>&copy; 2025 Grupo Portland. Todos los derechos reservados.</p>
        <p>Proyecto SAP S/4HANA</p>
    </footer>

    <!-- SCRIPT DE FUNCIONALIDAD -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- CONFIGURACIÓN DE ESTADO DE MANUALES ---
            // Cambia 'existe: true' a 'false' para deshabilitar botones.
            const configuracionManuales = {
                "ME21N": { archivo: "Manuales/Manual de Usuario- Creación de Pedido de Compra (ME21N)_v2.pdf", existe: true },
                "ME29N": { archivo: "Manuales/MANUAL_DE_USUARIO - LIBERACIÓN DE PEDIDOS DE COMPRA (ME29N).pdf", existe: true },
                "MIGO":  { archivo: "Manuales/Manual de Usuario-Registro de Entrada de Mercancías (MIGO).pdf", existe: true }, // Ejemplo: Pendiente
                "MAQ":  { archivo: "Manuales/MANUAL DE USUARIO - PROCESO DE MAQUILA (SUBCONTRATACIÓN) (ME21N).pdf", existe: true }, // Ejemplo: Pendiente                
                "MIRO":  { archivo: "Manuales/MANUAL DE USUARIO - REGISTRO DE FACTURAS (MIRO).pdf", existe: true },
                "F110":  { archivo: "Manuales/MANUAL DE USUARIO - PAGOS A PROVEEDORES.pdf", existe: true },
                
                "VA01":  { archivo: "Manuales/MANUAL DE USUARIO - GESTIÓN DE PEDIDOS DE VENTA (VA01).pdf", existe: true },
                "VL01N": { archivo: "Manuales/MANUAL DE USUARIO - EXPEDICIÓN DE SALIDA DE MERCADERÍA (VL01N).pdf", existe: true },
                "VF01":  { archivo: "Manuales/MANUAL DE USUARIO - EMISIÓN DE FACTURA DE CLIENTE (VF01).pdf", existe: true }, // Ejemplo: Pendiente
                "F-28":  { archivo: "Manuales/MANUAL DE USUARIO - CONTABILIZAR PAGOS DE CLIENTES (F-28).pdf", existe: true },
                "BP1":  { archivo: "Manuales/MANUAL DE USUARIO - Creación de Business Partner (BP) – Rol  Proveedor.pdf", existe: true },
                "BP2":  { archivo: "Manuales/MANUAL DE USUARIO - Creacion de Business Partner (BP) – ROL Cliente.pdf", existe: true },
                "BP3":  { archivo: "Manuales/MANUAL DE USUARIO - GESTIÓN DE CRÉDITO DEL INTERLOCUTOR COMERCIAL (BP).pdf", existe: true },                
                "INV":  { archivo: "Manuales/MANUAL DE USUARIO - GESTIÓN Y TOMA DE INVENTARIO FÍSICO.pdf", existe: true },   
                "MM01":  { archivo: "Manuales/MANUAL_DE_USUARIO - GESTIÓN Y CREACIÓN DE MATERIALES (MM01).pdf", existe: true },  
                "FB60":  { archivo: "Manuales/MANUAL DE USUARIO - REGISTRO DE FACTURAS MANUALES Y ANÁLISIS DE CUENTAS POR PAGAR.pdf", existe: true }, 
                "F-51":  { archivo: "Manuales/MANUAL DE USUARIO - EJECUCIÓN DE PAGO MANUAL A PROVEEDORES (F-51).pdf", existe: true },                                
            };

            const botones = document.querySelectorAll('.btn-manual');

            botones.forEach(boton => {
                const codigo = boton.getAttribute('data-manual');
                const config = configuracionManuales[codigo];

                if (config) {
                    if (config.existe) {
                        boton.href = config.archivo;
                        boton.target = "_blank";
                        boton.title = "Abrir documento PDF";
                    } else {
                        boton.classList.add('btn-disabled');
                        boton.href = "javascript:void(0)";
                        boton.removeAttribute('target');
                        boton.title = "Documentación en proceso";
                        
                        // Modificar visualmente el botón si está deshabilitado
                        const iconSpan = boton.querySelector('.btn-text');
                        if(iconSpan) iconSpan.innerHTML = '<i class="fa-solid fa-lock"></i> Pendiente';
                    }
                }
            });
        });
    </script>

    <script>
        const openRouterKey = "REPLACE_ME_WITH_API_KEY";
        const modelID = "xiaomi/mimo-v2-flash:free";        
//        const modelID = "nex-agi/deepseek-v3.1-nex-n1:free";
//        const manualURL = "https://garfiohook.github.io/Manuales_SAP/Manuales/Manual_de_Usuario_Consolidado.pdf";
        const supportEmail = "gsalinas@pjportland.cl";

const systemPrompt = `
Eres el "Instructor Senior de Procesos SAP para usuarios junior del Grupo Portland". Tu única fuente de verdad es el TEXTO ESTRUCTURADO DEL MANUAL: GRUPO PORTLAND - SAP S/4HANA que se presenta a continuación.
---
TEXTO ESTRUCTURADO DEL MANUAL: GRUPO PORTLAND - SAP S/4HANA

# I. GESTIÓN DE DATOS MAESTROS

## [TX: MM01 / MM03] Creación y Extensión de Materiales
*   **Módulo:** MM (Gestión de Materiales)
*   **Objetivo:** Definir propiedades logísticas, comerciales y contables de productos/servicios.
*   **Contexto Portland:** Función centralizada solicitada por usuario final y ejecutada por Equipo Central de Datos Maestros.

**5 Pasos del Proceso:**
1.  **Verificación (MM03):** Buscar existencia previa por descripción o grupo de artículos (F4) -> Evita duplicados.
2.  **Definición de Tipo (MM01):** Seleccionar HAWA (Mercadería) o DIEN (Servicio) -> Define lógica de comportamiento.
3.  **Selección de Vistas:** Elegir Datos Básicos, Ventas (1 y 2), Compras, Almacenamiento y Contabilidad 1 -> Habilitación de campos.
4.  **Niveles Organizativos:** Ingresar Centro y Almacén correspondiente -> Delimitación geográfica.
5.  **Configuración Contable:** Asignar Clase de Valoración Aplicable y Control de Precio -> Enlace financiero.

> ⚠️ **REGLA CRÍTICA:** La Unidad de Medida Base (ej. KG, UN) es inmutable una vez que el material tiene movimientos de stock. Validar con precisión antes de grabar.

## [TX: BP] Gestión de Interlocutores Comerciales (Socios de Negocio)
*   **Módulo:** Cross (FI/SD/MM)
*   **Objetivo:** Crear y extender capacidades de Clientes y Proveedores.

**5 Pasos del Proceso:**
1.  **Creación Inicial:** Seleccionar "Organización" e ingresar Razón Social, Dirección y Ciudad -> Identificación básica.
2.  **Datos Fiscales:** En pestaña "Identificador", ingresar NIF/RUC/NIT -> El sistema valida duplicidad y formato.
3.  **Extensión Financiera (Rol FLCU00 / FLVN00):** Clic en "Sociedad" -> Ingresar Cuenta Asociada para Clientes o Proveedores -> Enlace con Balance General.
4.  **Extensión Comercial (Rol FLCU01 - Cliente):** Clic en "Comercial" -> Definir Área de Ventas (Org, Canal, Sector) y Funciones de Interlocutor -> Habilita ventas.
5.  **Extensión Logística (Rol FLVN01 - Proveedor):** Clic en "Compras" -> Definir Org. Compras y Moneda del pedido -> Habilita órdenes de compra.

## [TX: BP] Gestión de Crédito (Rol UKM000 - SAP Credit Management)
* **Módulo:** FI / SD (Credit Management)
* **Objetivo:** Definir la solvencia cualitativa (Riesgo) y el límite monetario (Cuantitativo) del cliente.
* **Responsable:** Responsable de Crédito.

**7 Pasos del Proceso:**
1. **Acceso (BP):** Buscar el código del Interlocutor Comercial -> Acceso al dato maestro.
2. **Modo Modificar:** Clic en botón "Conmutar entre visualizar y modificar" (icono lápiz) -> Habilita edición.
3. **Selección de Rol:** En "Tratar función IC", elegir **UKM000 - SAP Credit Management** -> Habilita pestañas "Perfil de Crédito" y "Datos de Segmento".
4. **Perfil de Crédito (Global):** En pestaña "Perfil de Crédito", ingresar la **Clase de Riesgo** (ej. A, B, C) -> Define la probabilidad de incumplimiento global.
5. **Regla de Verificación:** Confirmar que la regla sea **01 (Sin cálculo automático)** -> El cálculo del riesgo se gestiona manualmente según política interna.
6. **Segmento de Crédito (Local):** Clic en "Datos de Segmento de Crédito" y seleccionar el segmento según la Sociedad -> Unidad de riesgo específica.
7. **Asignación de Límite:** En pestaña "Límite de crédito", ingresar el monto máximo de exposición monetaria (Límite) -> Techo de crédito para ventas.

> ⚠️ **REGLA CRÍTICA:** La Clase de Riesgo es cualitativa y global (aplica a todas las filiales), mientras que el Límite Monetario es local por Segmento de Crédito.

# II. CICLO DE COMPRAS Y SUMINISTRO (PROCURE-TO-PAY)

## [TX: ME21N] Creación de Pedido de Compra (OC)
*   **Contexto Portland:** Define el costo total del inventario (Precio Efectivo).

### Catálogo de Configuración Portland:
*   **Ejemplo de Tipos de Pedido:** **ZNAC** (Nacional), **ZIMP** (Importación Stock), **ZDIR** (Despacho Directo), **ZMAQ** (Maquila).
*   **Ejemplo de Clases de Valoración:** **DIST_LO_GE** (Importado), **NACIONAL** (Local), **PRODUCCION** (Maquila).
*   **Ejemplo de Condiciones de Precio (Z):** **ZFLE** (Flete), **ZSEG** (Seguro), **ZAGA** (Aduana), **ZTNA** (Transporte local).

** 7 Pasos del Proceso:**
1.  **Cabecera:** Elegir Clase de Pedido (ej. **ZIMP** para Importacion para Distribución Local }) e ingresar Proveedor -> Inicio de documento.
2.  **Datos Org:** Ingresar Org. Compras, Grupo Compras y Sociedad -> Estructura legal.
3.  **Incoterms:** (SOLO IMPORTACION) Ingresar la Condicion de Incoterms y puerto de embarque aplicable al pedido -> Define Estructura de costos.
4.  **Posiciones:** Detallar Material, Cantidad, Precio y Centro -> Carga de líneas.
5.  **Pestaña Entrega:** Seleccionar la Clase de Valoración correcta (ej. **DIST_LO_GE** para Distribucion Local General) -> ⚠️ **REGLA CRÍTICA:** No omitir este paso para evitar promediar costos de operaciones distintas.
6.  **Pestaña Condiciones:** Cargar códigos de Condiciones de Precio Aplicables si es un pedido de Importación (Ej. ZFLE, ZSEG, etc.) y montos adicionales -> El sistema calcula el Precio Efectivo de ingreso.
7.  **Grabar:** Presionar "Verificar" e ícono de "Grabar" -> Genera número de OC.

## [TX: MIGO] Registro de Entrada de Mercancías
*   **Módulo:** MM
*   **Regla de Negocio:** Solo registrar cuando el material ha ingresado físicamente.

** 5 Pasos del Proceso:**
1.  **Acceso:** Seleccionar "Entrada de mercancías" y referencia "Pedido" -> Ingresar N° de OC.
2.  **Cabecera:** Validar Clase de Movimiento **101** y ajustar Fecha de Contabilización a la fecha real de recepción física -> Garantiza realidad operativa.
3.  **Referencia:** Ingresar número de "Nota de Entrega" o Guía del proveedor -> Trazabilidad documental.
4.  **Posición:** En pestañas inferiores, verificar Cantidad, Almacén y marcar checkbox "Posición OK" -> Conformidad de línea.
5.  **Contabilizar:** Clic en "Contabilizar" -> Genera Documento de Material y aumenta stock.

# III. CICLO DE VENTAS Y DISTRIBUCIÓN (ORDER-TO-CASH)

## [TX: VA01] Creación de Pedido de Venta
*   **Módulo:** SD
*   **Contexto Portland:** Contrato formal que reserva inventario y valida riesgo.

**5 Pasos del Proceso:**
1.  **Inicio:** Clase de Pedido (ej. **Z01D** para Distribución Local), Org. Ventas , Canal, Sector -> Contexto filial.
2.  **Cabecera:** Ingresar Cliente y Referencia (Según OC física del cliente) -> Datos de contrato.
3.  **Posiciones:** Ingresar Material y Cantidad -> El sistema realiza Verificación de Disponibilidad.
4.  **Precios:** Ingresar/Validar condición de Precio Base **PR00** y verificar Margen de Cobertura -> ⚠️ **REGLA CRÍTICA:** Márgen debe cumplir las politicas comerciales.
5. **Control de Crédito:** Al grabar, el sistema suma: **Valor Pedido + Comprometido** (pedidos abiertos) + **Agotado** (facturas pendientes).
    * **Resultado:** Si excede el límite, emite "Verificación de crédito sin éxito" y guarda con **Bloqueo de Crédito**.
    * **Acción:** El pedido no podrá procesarse por logística; el Responsable de Crédito debe liberarlo.

## [TX: VL01N / VL02N] Expedición (Salida de Mercancía)
*   **Módulo:** Logística (LE-SD)

**3 Pasos del Proceso:**
1.  **Creación (VL01N):** Referenciar Pedido de Venta -> Genera Entrega de Salida (80XXXXXX).
2.  **Picking (VL02N):** En pestaña Picking, ingresar cantidad real cargada, Almacén y Lote -> Preparación física.
3.  **Contabilizar SM:** Clic en botón "Contabilizar SM" -> Ejecuta Movimiento **601**, rebaja inventario y registra Costo de Venta (CoMV).

## [TX: VF01] Emisión de Factura de Cliente
1.  **Acción:** Referenciar número de Entrega de Salida -> Carga datos comerciales.
2.  **Grabar:** Genera documento factura y cuenta por cobrar -> Registro final de ingreso.

# IV. FINANZAS Y CONTROL DE INVENTARIO

## [TX: MIRO] Registro de Factura Logística (Acreedores)
> ⚠️ **REGLA CRÍTICA:** NUNCA utilizar **FB60** para facturas que tengan una Orden de Compra relacionada. Esto dejaría la provisión EM/RF abierta. Usar MIRO en esos casos.

1.  **Cabecera:** Ingresar Fecha, Referencia (N° Factura física) e Importe Total.
2.  **Referencia:** Ingresar N° de OC -> El sistema cruza Pedido-Recepción-Factura.
3.  **Contabilizar:** Verificar que el saldo sea Cero y Grabar -> Salda provisión y crea obligación de pago.

## [TX: F-53] Contabilizar Pago Saliente a Proveedor/Acreedor (Pago Manual)
* **Responsable:** Responsable de Cuentas por Pagar.
1.  **Cabecera:** Ingresar Fecha y Clase de Documento **KZ** (Pago Acreedor).
2.  **Banco:** Ingresar cuenta de mayor del banco e Importe total a pagar.
3.  **Selección:** En "Selección PA", ingresar código de Acreedor y clic en "Tratar Partidas Abiertas".
4.  **Compensación:** Doble clic sobre las facturas para saldarlas.
5.  **Validación:** El campo "No asignado" DEBE ser cero antes de Contabilizar.

## [TX: F110] Programa de Pagos Automáticos a Proveedor/Acreedor (APP)
* **Responsable:** Responsable de Tesorería.
1.  **Parámetros:** Definir Fecha de Ejecución, ID, Sociedades y Métodos de Pago.
2.  **Propuesta:** Clic en "Propuesta" -> El sistema lista partidas sin bloqueos.
3.  **Revisión:** Visualizar propuesta para excluir o liberar facturas.
4.  **Ejecutar Pago:** Contabiliza documentos FI y genera archivo para el banco.

## [TX: F-28] Contabilizar Pago de Cliente (Cobranza)
1.  **Entrada:** Ingresar Banco e Importe recibido -> Registro de entrada de dinero.
2.  **Compensación:** Ingresar Código de Cliente y seleccionar facturas pagadas -> El campo "No asignado" debe ser Cero -> Grabar.

## [TX: MI01 / MI04 / MI07] Toma de Inventario Físico
1.  **MI01 (Creación):** Generar documento de inventario. **REGLA:** Marcar "Bloquear contabilizaciones" para congelar el stock teórico.
2.  **MI04 (Recuento):** Ingresar cantidades físicas contadas -> Usar "Recuento Cero" si no hay existencia.
3.  **MI07 (Ajuste):** Contabilizar diferencias -> El sistema genera movimientos **701** (sobrante) o **702** (faltante).

# V. REPORTES Y MONITOREO

* **UKM_BP:** Visualizar Perfil de Crédito, exposición y riesgo [TX: UKM_BP].
* **UKM_CASE:** Decisiones de Crédito Documentadas (DCD) por incumplimiento de límite [TX: UKM_CASE].
* **FBL1N:** Verificar facturas pendientes o pagadas de Acreedores [TX: FBL1N].
* **MRBR:** Liberar facturas bloqueadas por discrepancias de precio/cantidad [TX: MRBR].
---
FIN DEL TEXTO ESTRUCTURADO DEL MANUAL: GRUPO PORTLAND - SAP S/4HANA.
---
REGLAS DE ORO:
1. Si el usuario pregunta por un proceso que NO está en el TEXTO ESTRUCTURADO DEL MANUAL: GRUPO PORTLAND - SAP S/4HANA, debes responder: 
   "Lo siento, no tengo información suficiente sobre ese proceso en el manual oficial. ¿Deseas enviar tu consulta directamente al área de soporte SAP?"
   Y OBLIGATORIAMENTE debes incluir el siguiente enlace en tu respuesta: [Enviar consulta a soporte](mailto:gsalinas@pjportland.cl?subject=Pregunta%20SAP).
2. Siempre utiliza negritas para códigos de transacción (ej. **MIGO**, **ME21N**).
3. Si el manual menciona una "Regla Crítica", "Advertencia" o "Nota de Grupo Portland", resáltala usando bloques de aviso o prefijos claros (EJ: ⚠️ REGLA CRÍTICA).
4. Para instrucciones, usa siempre listas numeradas de "Acción -> Resultado".
5. Cuando expliques pasos de una transacción, utiliza SIEMPRE listas numeradas (1. 2. 3.) para que el sistema pueda aplicar el diseño de tarjetas de proceso.
6. Mantén un tono profesional, preciso y orientado a la normativa del Grupo.
7. Solo si el usuario consulta sobre un proceso de compra, debes cruzar la información de las 3 tablas a continuacion (Tipo de Pedido + Clase de Valoración + Condiciones) para dar una respuesta integral y coherente con el tipo de negocio.
---
### 1. MATRIZ DE TIPOS DE NEGOCIO Y PEDIDOS DE COMPRA DE IMPORTACIÓN (NO APLICA A PEDIDOS DE VENTA)
Dependiendo del negocio, el usuario solo DEBE usar alguno de estos tipos de pedido de compra definidos por Portland:
- **Distribución Local [ZIMP]:** Importación para stock.
- **Despacho Directo [ZDIR]:** Importación calzada, sin stock, entrega en cliente. Portland paga todos los costos de de internación.
- **Trading Terceros [ZTRA]:** Importación calzada. Cliente paga internación y transporte.
- **Trading Filiales [ZTRF]:** Abastecimiento a filiales (Perú/Colombia). Filiales pagan internación y transporte.

### 2. MATRIZ DE TIPOS DE NEGOCIO Y PEDIDOS DE COMPRA NACIONAL O LOCAL (NO APLICA A PEDIDOS DE VENTA)
- **Nacional [ZNAC]:** Compras locales para stock.
- **Maquila [ZMAQ]:** Transformación o re-envasado.
- **Indent [ZIND]:** Servicios de Representacion. Mercadería es propiedad de terceros.
- **Servicios [ZSER]:** Gastos de servicios (Transporte, consultoría).
- **Insumos [ZINS]:** Embalajes, combustible. Imputación directa a centro de costo.

### 3. MATRIZ DE CLASES DE VALORACIÓN PARA PEDIDOS DE COMPRA DE IMPORTACIÓN (NO APLICA A PEDIDOS DE VENTA)
Es crítico seleccionar la valoración correcta según el negocio:
- **Distribución Local General:** DIST_LO_GE.
- **Distribución Local Granel Liquido:** DIST_LO_LQ.
- **Distribución Local Granel Solido:** DIST_LO_SO.
- **Distribución Local Rail Car:** DIST_LO_RC.
- **Despacho Directo General:** DIRECTO_GE.
- **Despacho Directo Granel Liquido:** DIRECTO_LQ.
- **Despacho Directo Granel Solido:** DIRECTO_SO.
- **Despacho Directo Rail Car:** DIRECTO_RC.
- **Trading Terceros/Filiales:** TRADING.

### 4. MATRIZ DE CLASES DE VALORACIÓN PARA PEDIDOS DE COMPRA NACIONAL (NO APLICA A PEDIDOS DE VENTA)
- **Nacional / Insumos:** NACIONAL.
- **Maquila:** PRODUCCION.
- **Indent:** SIN VALOR.

### 5. MATRIZ DE CONDICIONES DE PRECIO (SOLO PARA PEDIDOS DE COMPRAS DE IMPORTACIÓN)
Al definir la valoración, se deben aplicar estas condiciones en la pestaña de 'Condiciones' del pedido:
- **Básicas:** PB00/PBXX (Mercadería), ZFLE (Flete Int.), ZSEG/ZSE2 (Seguro).
- **Gastos Aduana/Puerto:** - **ZAGA:** Agencia Aduana (Perú: 0.25% CIF / Col: 0.30% CFR).
    - **ZCDI:** Gastos Operativos/Despacho en puerto.
    - **ZTHC:** Gastos de manipulación (THC).
    - **ZTNA:** Transporte Nacional (Puerto a Bodega).
    - **ZUYD/ZCDA:** Gastos SEREMI/Autoridad Sanitaria.
- **Otros:** ZCAN (Canje BL), ZGAT (Gate in/out), ZGGR (Graneles/Surveyer), ZCOM (Comodato).

---

### INSTRUCCIONES DE INTERACCIÓN:
1. **Validación Proactiva:** Si el usuario dice "Voy a hacer un pedido ZDIR", respóndele: "Para Despacho Directo (ZDIR), recuerda usar clases de valoración tipo DIRECTO_XX y no olvides cargar las condiciones de importación (ZFLE, ZSEG, ZAGA, etc.)".
2. **Contexto Regional:** Si menciona Perú o Colombia, utiliza las homologaciones específicas (ej: para ZAGA en Colombia, indicar 'Comisión SIA').
3. **Formato:** Usa tablas Markdown para comparar datos si el usuario tiene dudas entre dos tipos de pedido.
4. **Restricción:** No permitas mezclar tipos de pedido con valoraciones que no correspondan (ej: ZNAC con valoración TRADING es un error).

`;

        const chatBox = document.getElementById('chatBox');
        const chatForm = document.getElementById('chatForm');
        const userInput = document.getElementById('userInput');
        const typingIndicator = document.getElementById('typingIndicator');
        const floatingChat = document.getElementById('floatingChat');
        const toggleIcon = document.getElementById('toggleIcon');
        const chatToggleBtn = document.getElementById('chatToggleBtn');

        let isChatOpen = false;
        let conversationHistory = [];

        // --- RENDERIZADO MEJORADO ---
        function cleanRender(text) {
            let html = text
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h3>$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/^\s*[-*+]\s+(.*)/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)+/gs, (match) => `<ul class="list-disc ml-5 my-3">${match}</ul>`)
                .replace(/^\s*\d+\.\s+(.*)/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)+/gs, (match) => match.includes('list-disc') ? match : `<ol class="list-decimal ml-5 my-3">${match}</ol>`)
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');

            return `<div class="chat-bubble-content">${html}</div>`;
        }

        // --- PERSISTENCIA ---
        function saveSession() {
            sessionStorage.setItem('portland_chat_session', JSON.stringify(conversationHistory));
        }

        function loadSession() {
            const saved = sessionStorage.getItem('portland_chat_session');
            if (saved) {
                conversationHistory = JSON.parse(saved);
                renderHistory();
            } else {
                conversationHistory = [{ role: "system", content: systemPrompt }];
                addMessage("¡Hola! Soy el asistente de SAP para el Grupo Portland. Estoy para ayudarte con tus procesos.", 'assistant', false);
            }
        }

        function renderHistory() {
            chatBox.innerHTML = '';
            conversationHistory.forEach(msg => {
                if (msg.role !== 'system') {
                    addMessage(msg.content, msg.role, false);
                }
            });
        }

        function toggleChat() {
            isChatOpen = !isChatOpen;
            const chat = document.getElementById('floatingChat');
            const icon = document.getElementById('toggleIcon');
            const btn = document.getElementById('chatToggleBtn');
            const label = document.getElementById('chatLabel'); // Nueva referencia

            if (isChatOpen) {
                chat.classList.add('active');
                label.classList.add('hidden-label'); // Oculta el texto
                icon.className = "fas fa-chevron-down text-2xl";
                btn.classList.remove('pulse-animation');
            } else {
                chat.classList.remove('active');
                label.classList.remove('hidden-label'); // Muestra el texto
                icon.className = "fas fa-comment-dots text-2xl";
                btn.classList.add('pulse-animation');
            }
        }

function addMessage(text, role, save = true) {
    const chatBox = document.getElementById('chatBox');
    const wrapper = document.createElement('div');
    wrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} mb-4 animate-fade-in`;

    const bubble = document.createElement('div');
    // Mantenemos 'relative' para posicionar el botón de PDF arriba a la derecha
    bubble.className = `p-4 rounded-2xl max-w-[85%] shadow-sm relative ${
        role === 'user' 
        ? 'bg-[#003366] text-white rounded-tr-none' 
        : 'bg-white border border-gray-200 text-gray-800 rounded-tl-none chat-bubble-content'
    }`;

    if (role === 'assistant') {
        // --- 1. REINCORPORACIÓN DEL BOTÓN PDF ---
        const pdfBtn = document.createElement('button');
        pdfBtn.className = "pdf-export-btn";
        pdfBtn.innerHTML = '<i class="fas fa-file-pdf"></i>';
        // Usamos una función anónima para pasar el 'text' original que contiene el Markdown
        pdfBtn.onclick = (e) => {
            e.stopPropagation(); // Evita que otros eventos interfieran
            exportToPDF(text);
        };
        bubble.appendChild(pdfBtn);

        // --- 2. RENDERIZADO DE CONTENIDO (Markdown + Soporte) ---
        const contentDiv = document.createElement('div');
        let htmlContent = marked.parse(text);
        
        // Lógica de detección para el botón de soporte por correo
        const noInfoKeywords = ["no tengo información", "no se encuentra documentado", "consulta con tu key user", "Si tienes dudas"];
        if (noInfoKeywords.some(k => text.toLowerCase().includes(k))) {
            const lastUserMsg = conversationHistory.filter(m => m.role === 'user').pop()?.content || "";
            const safeQuestion = lastUserMsg.replace(/'/g, "\\'").replace(/"/g, "&quot;");
            htmlContent += `
                <div class="support-container" style="margin-top: 15px; padding: 15px; background-color: #f0f7ff; border: 1px dashed #003366; border-radius: 12px; text-align: center;">
                    <p style="font-size: 11px; color: #003366; margin-bottom: 8px; font-weight: bold;">¿Deseas soporte adicional?</p>
                    <button onclick="sendToSupport('${safeQuestion}')" class="support-btn">
                        <i class="fas fa-envelope mr-2"></i> Enviar consulta a gsalinas@pjportland.cl
                    </button>
                </div>`;
        }
        
        contentDiv.innerHTML = htmlContent;
        bubble.appendChild(contentDiv);
    } else {
        bubble.textContent = text;
    }

    wrapper.appendChild(bubble);
    chatBox.appendChild(wrapper);
    
    // --- 3. CORRECCIÓN DEL SCROLL (Lectura desde el inicio) ---
    // Si es un mensaje corto del usuario, hacemos scroll al final.
    // Si es una respuesta larga de la IA, el scroll se queda quieto para permitir leer el inicio.
    if (role === 'user') {
        chatBox.scrollTop = chatBox.scrollHeight;
    } else {
        // Solo hacemos un pequeño ajuste para asegurar que el mensaje sea visible,
        // pero NO forzamos el scroll al final de la tabla/texto largo.
        wrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    if (save) {
        conversationHistory.push({ role, content: text });
        sessionStorage.setItem('portland_chat_session', JSON.stringify(conversationHistory));
    }
}

/**
 * Función auxiliar para abrir Outlook con la pregunta precargada
 */
function sendToSupport(userQuestion) {
    const email = "gsalinas@pjportland.cl";
    const subject = "Pregunta SAP";
    
    // Limpieza de texto para evitar errores en el enlace mailto
    const cleanQuestion = userQuestion.replace(/[\r\n]+/g, " ").trim();
    const body = `Hola Soporte,\n\nTengo la siguiente duda respecto a los procesos SAP:\n\n"${cleanQuestion}"\n\nQuedo atento a sus comentarios.`;
    
    // Generar link y redireccionar
    const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = mailtoLink;
}

// Función auxiliar para gestionar el envío a Outlook
function sendToSupport(userQuestion) {
    const email = "gsalinas@pjportland.cl";
    const subject = "Pregunta SAP";
    
    // Limpiamos la pregunta de saltos de línea extra o caracteres que bloquean el mailto
    const cleanQuestion = userQuestion
        .replace(/[\r\n]+/g, " ") // Quita saltos de línea
        .trim();

    const body = `Hola Soporte,\n\nTengo la siguiente duda respecto a los procesos SAP:\n\n"${cleanQuestion}"\n\nQuedo atento a sus comentarios.`;
    
    // Usamos el constructor de URLSearchParams para asegurar una codificación perfecta
    const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    
    window.location.href = mailtoLink;
}

        async function callOpenRouter() {
            const url = "https://openrouter.ai/api/v1/chat/completions";
            const payload = {
                model: modelID,
                messages: conversationHistory,
                temperature: 0.1
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openRouterKey}`,
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'Portland SAP Assistant'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                return data.choices?.[0]?.message?.content || "Error en respuesta.";
            } catch (e) {
                return "Error de red con el asistente de IA.";
            }
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = userInput.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            userInput.value = '';
            typingIndicator.classList.remove('hidden');
            chatBox.scrollTop = chatBox.scrollHeight;

            const response = await callOpenRouter();
            typingIndicator.classList.add('hidden');
            addMessage(response, 'assistant');
        });

        function triggerEmailEscalation(btn) {
            const nameInput = btn.parentElement.querySelector('#ticketName');
            const userName = nameInput.value.trim();
            if (!userName) { nameInput.classList.add('border-red-500'); return; }

            const userQuestion = conversationHistory[conversationHistory.length - 2].content;
            const subject = encodeURIComponent("SOPORTE SAP PORTLAND: Duda no resuelta por Manual");
            const body = encodeURIComponent(`Equipo de Proyecto,\n\nSe requiere soporte para el siguiente caso:\n\nUsuario: ${userName}\nConsulta: ${userQuestion}\n\nNota: Consulta generada desde el Portal de Capacitación.`);
            
            window.location.href = `mailto:${supportEmail}?subject=${subject}&body=${body}`;
            btn.parentElement.innerHTML = '<p class="text-blue-600 font-bold text-center py-2 text-xs"><i class="fas fa-check-circle mr-2"></i> Mail preparado con éxito.</p>';
        }

function exportToPDF(text) {
    // 1. Crear el contenedor virtual
    const element = document.createElement('div');
    const contentHtml = marked.parse(text);
    
    // 2. Aplicar estilos de reseteo total al contenedor
    // Importante: padding: 0 y margin: 0 para que html2pdf empiece en el tope
    element.style.width = '190mm'; // Ancho A4 aproximado
    element.style.margin = '0';
    element.style.padding = '0';
    element.style.backgroundColor = 'white';

    element.innerHTML = `
        <div style="padding: 20px; font-family: 'Segoe UI', Arial, sans-serif; color: #333;">
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #003366; padding-bottom: 10px; margin-bottom: 20px;">
                <div>
                    <div style="color: #003366; font-weight: 800; font-size: 20px;">GRUPO PORTLAND</div>
                    <div style="color: #6bae47; font-weight: 600; font-size: 11px;">MANUAL DE PROCESOS SAP S/4HANA</div>
                </div>
                <div style="text-align: right; color: #666; font-size: 10px;">
                    Generado el: ${new Date().toLocaleDateString()}<br>
                    ID: ${Math.floor(Math.random() * 1000000)}
                </div>
            </div>

            <style>
                /* Estilos para evitar saltos y espacios */
                .pdf-body { width: 100%; margin: 0; padding: 0; }
                ol { counter-reset: step-counter; list-style-type: none; padding-left: 0; margin: 10px 0; }
                ol li { 
                    position: relative; margin-bottom: 10px; padding: 10px 10px 10px 45px; 
                    background-color: #f1f5f9; border-radius: 6px; border-left: 5px solid #003366;
                    font-size: 11px; page-break-inside: avoid;
                }
                ol li::before { 
                    content: counter(step-counter); counter-increment: step-counter; 
                    position: absolute; left: 10px; top: 50%; transform: translateY(-50%); 
                    background-color: #003366; color: white; width: 22px; height: 22px; 
                    border-radius: 50%; display: flex; align-items: center; justify-content: center; 
                    font-weight: bold; font-size: 10px;
                }
                table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                th { background-color: #003366; color: white; padding: 8px; border: 1px solid #003366; text-align: left; font-size: 10px; }
                td { padding: 6px; border: 1px solid #cbd5e1; font-size: 9px; }
                tr:nth-child(even) { background-color: #f8fafc; }
                h1, h2, h3 { color: #003366; margin-top: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; font-size: 14px; }
                p { font-size: 11px; line-height: 1.5; margin-bottom: 8px; }
            </style>

            <div class="pdf-body">
                ${contentHtml}
            </div>
            <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 10px; text-align: center; font-size: 8px; color: #999;">
                Documento de consulta rápida - Portland SAP S/4HANA
            </div>
        </div>
    `;

    // 3. Configuración CLAVE para eliminar los saltos iniciales
    const opt = {
        margin: [10, 10, 10, 10],
        filename: 'Guia_Proceso_Portland.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
            scale: 2, 
            useCORS: true,
            scrollY: 0, // FUERZA a empezar en el tope del elemento, no del scroll del chat
            scrollX: 0,
            windowHeight: element.scrollHeight, // Limita el alto al contenido real
            y: 0 // Asegura coordenada Y inicial cero
        },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['css', 'legacy'] }
    };

    // 4. Ejecutar (sin añadir al body para evitar interferencias de scroll)
    html2pdf().set(opt).from(element).save();
}
        function clearChat() {
            if(confirm("¿Estás seguro de que deseas borrar todo el historial de esta sesión?")) {
                sessionStorage.removeItem('portland_chat_session');
                conversationHistory = [{ role: "system", content: systemPrompt }];
                chatBox.innerHTML = '';
                addMessage("Historial borrado. Estoy listo para una nueva consulta.", 'assistant', false);
            }
        }

        // Inicialización
        window.onload = loadSession;
</script>

</body>
</html>
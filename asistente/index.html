<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente IA SAP S/4HANA - Grupo Portland</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./libs/font-awesome/css/all.min.css">
    <link rel="stylesheet" href="./css/output.css">
    <script src="./libs/html2pdf.bundle.min.js"></script>
    <script src="./libs/marked.min.js"></script>

</head>

<body>

    <header>
        <div class="logo-container">
            <img src="./Imagenes/Logo_Portland.png" alt="Grupo Portland" class="logo-img">
        </div>
        <img src="./Imagenes/Logo_Portland.png" alt="SAP" class="logo-img sap-logo">
    </header>

    <main class="chat-main-container">
        <div class="chat-interface">
            <div class="bg-[#003366] p-4 text-white flex items-center justify-between shadow-md z-10">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center backdrop-blur-sm">
                        <i class="fas fa-robot text-lg"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-lg">Asistente IA Portland</h4>
                        <p class="text-xs text-blue-200">Experto en procesos SAP S/4HANA</p>
                    </div>
                </div>
                <div>
                    <button onclick="clearChat()" class="p-2 hover:bg-white/10 rounded-lg transition-colors text-sm"
                        title="Borrar Historial">
                        <i class="fas fa-trash-alt mr-1"></i> Nueva Consulta
                    </button>
                </div>
            </div>

            <div id="chatBox" class="flex-grow overflow-y-auto p-6 space-y-6 bg-slate-50 relative scroll-smooth">
            </div>

            <div id="typingIndicator" class="hidden px-6 py-2 bg-slate-50 border-t border-slate-100">
                <div class="flex space-x-2 items-center text-xs text-slate-400">
                    <span>El asistente está escribiendo</span>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>

            <div class="p-5 bg-white border-t border-slate-200">
                <form id="chatForm" class="flex items-center gap-3">
                    <input type="text" id="userInput"
                        placeholder="Describe tu proceso o transacción (Ej: ¿Cómo crear un pedido en ME21N?)..."
                        class="flex-grow p-4 bg-slate-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all text-gray-700 placeholder-gray-400">
                    <button type="submit"
                        class="bg-[#003366] text-white w-14 h-14 rounded-xl hover:bg-[#002244] transition-all flex items-center justify-center shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                        <i class="fas fa-paper-plane text-lg"></i>
                    </button>
                </form>
                <div class="text-center mt-2">
                    <p class="text-xs text-gray-400">La IA puede cometer errores. Verifica la información importante en
                        los manuales oficiales.</p>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 Grupo Portland. Proyecto SAP S/4HANA</p>
    </footer>

    <script>
        const openRouterKey = "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";
        const modelID = "xiaomi/mimo-v2-flash:free";
        const supportEmail = "gsalinas@pjportland.cl";

        let systemPrompt = "";
        let conversationHistory = [];

        const chatBox = document.getElementById('chatBox');
        const chatForm = document.getElementById('chatForm');
        const userInput = document.getElementById('userInput');
        const typingIndicator = document.getElementById('typingIndicator');

        // --- SISTEMA ---
        async function fetchSystemPrompt() {
            try {
                const response = await fetch('../system_prompt.txt?v=' + Date.now());
                if (!response.ok) throw new Error("No se pudo cargar el system prompt");
                systemPrompt = await response.text();
            } catch (error) {
                console.error("Error cargando el prompt:", error);
                systemPrompt = "Eres un asistente de SAP para Grupo Portland.";
            }
        }

        async function loadSession() {
            await fetchSystemPrompt();
            const saved = sessionStorage.getItem('portland_chat_session');

            if (saved) {
                conversationHistory = JSON.parse(saved);
                if (conversationHistory.length > 0 && conversationHistory[0].role === 'system') {
                    conversationHistory[0].content = systemPrompt;
                }
                renderHistory();
            } else {
                conversationHistory = [{ role: "system", content: systemPrompt }];
                addMessage("¡Hola! Soy el asistente virtual de SAP. ¿En qué proceso puedo ayudarte hoy?", 'assistant', false);
            }
        }

        function renderHistory() {
            chatBox.innerHTML = '';
            conversationHistory.forEach(msg => {
                if (msg.role !== 'system') {
                    addMessage(msg.content, msg.role, false);
                }
            });
        }

        // --- RENDERIZADO DE MENSAJES ---
        function addMessage(text, role, save = true) {
            const wrapper = document.createElement('div');
            wrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in`;

            const bubble = document.createElement('div');
            bubble.className = `p-5 rounded-2xl max-w-[90%] lg:max-w-[85%] shadow-sm relative text-base ${role === 'user'
                ? 'bg-[#003366] text-white rounded-tr-sm'
                : 'bg-white border border-gray-100 text-gray-800 rounded-tl-sm chat-bubble-content'
                }`;

            if (role === 'assistant') {
                // Botón PDF
                const pdfBtn = document.createElement('button');
                pdfBtn.className = "pdf-export-btn";
                pdfBtn.innerHTML = '<i class="fas fa-file-pdf"></i>';
                pdfBtn.title = "Descargar instrucciones en PDF";
                pdfBtn.onclick = (e) => { e.stopPropagation(); exportToPDF(text); };
                bubble.appendChild(pdfBtn);

                // Contenido Markdown
                const contentDiv = document.createElement('div');
                let htmlContent = marked.parse(text);

                // Botón de soporte condicional
                const noInfoKeywords = ["no tengo información", "no se encuentra documentado", "Enviar consulta a soporte", "Si tienes dudas"];
                if (noInfoKeywords.some(k => text.toLowerCase().includes(k.toLowerCase()))) {
                    const lastUserMsg = conversationHistory.filter(m => m.role === 'user').pop()?.content || "";
                    const safeQuestion = lastUserMsg.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                    htmlContent += `
                        <div class="support-container" style="margin-top: 20px; padding: 15px; background-color: #f0f7ff; border: 1px dashed #003366; border-radius: 12px; text-align: center;">
                            <p style="font-size: 12px; color: #003366; margin-bottom: 8px; font-weight: bold;">¿Necesitas escalar este caso?</p>
                            <button onclick="sendToSupport('${safeQuestion}')" class="support-btn">
                                <i class="fas fa-envelope mr-2"></i> Contactar a Soporte TI
                            </button>
                        </div>`;
                }

                contentDiv.innerHTML = htmlContent;
                bubble.appendChild(contentDiv);
            } else {
                bubble.textContent = text;
            }

            wrapper.appendChild(bubble);
            chatBox.appendChild(wrapper);

            // Auto Scroll
            chatBox.scrollTop = chatBox.scrollHeight;

            if (save) {
                conversationHistory.push({ role, content: text });
                sessionStorage.setItem('portland_chat_session', JSON.stringify(conversationHistory));
            }
        }

        // --- COMUNICACIÓN API ---
        async function callOpenRouter() {
            const url = "https://openrouter.ai/api/v1/chat/completions";
            const payload = {
                model: modelID,
                messages: conversationHistory,
                temperature: 0.1
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openRouterKey}`,
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'Portland SAP Assistant'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                return data.choices?.[0]?.message?.content || "Lo siento, hubo un error procesando la respuesta.";
            } catch (e) {
                return "Error de conexión con el servidor de IA.";
            }
        }

        // --- EVENT HANDLERS ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = userInput.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            userInput.value = '';

            typingIndicator.classList.remove('hidden');
            chatBox.scrollTop = chatBox.scrollHeight; // Scroll al fondo para ver el indicador

            const response = await callOpenRouter();

            typingIndicator.classList.add('hidden');
            addMessage(response, 'assistant');
        });

        function clearChat() {
            if (confirm("¿Borrar historial actual?")) {
                sessionStorage.removeItem('portland_chat_session');
                conversationHistory = [{ role: "system", content: systemPrompt }];
                chatBox.innerHTML = '';
                addMessage("Historial borrado. ¿En qué más puedo ayudarte?", 'assistant', false);
            }
        }

        function sendToSupport(userQuestion) {
            const email = "gsalinas@pjportland.cl";
            const subject = "Pregunta SAP - Asistente IA";
            const cleanQuestion = userQuestion.replace(/[\r\n]+/g, " ").trim();
            const body = `Hola Soporte,\n\nTengo la siguiente duda que el asistente no pudo resolver completamente:\n\n"${cleanQuestion}"\n\nQuedo atento.`;
            window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

        function exportToPDF(text) {
            const element = document.createElement('div');
            const contentHtml = marked.parse(text);
            element.style.width = '190mm';
            element.style.backgroundColor = 'white';
            element.innerHTML = `
                <div style="padding: 30px; font-family: sans-serif; color: #333;">
                    <div style="border-bottom: 3px solid #003366; padding-bottom: 15px; margin-bottom: 25px;">
                        <div style="color: #003366; font-weight: 800; font-size: 22px;">GRUPO PORTLAND</div>
                        <div style="color: #6bae47; font-weight: 600; font-size: 12px;">ASISTENTE SAP S/4HANA</div>
                    </div>
                    <style>
                        ol { counter-reset: step-counter; list-style-type: none; padding-left: 0; }
                        ol li { position: relative; margin-bottom: 10px; padding: 8px 10px 8px 35px; background-color: #f1f5f9; border-left: 4px solid #003366; font-size: 11px; }
                        ol li::before { content: counter(step-counter); counter-increment: step-counter; position: absolute; left: 8px; top: 50%; transform: translateY(-50%); background-color: #003366; color: white; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: bold; }
                        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 10px; }
                        th { background-color: #003366; color: white; padding: 6px; }
                        td { border: 1px solid #ddd; padding: 6px; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                    </style>
                    <div style="font-size: 12px; line-height: 1.6;">${contentHtml}</div>
                </div>`;

            html2pdf().set({
                margin: 10,
                filename: 'Instructivo_SAP_Portland.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).from(element).save();
        }

        // Inicialización
        window.onload = loadSession;
    </script>
</body>

</html>